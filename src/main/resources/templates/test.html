<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WQM ëŒ€ê¸°ì—´ ì‹œë®¬ë ˆì´í„° (Multi-Test)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .control-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; position: sticky; top: 20px; z-index: 100; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }

        /* ìœ ì € ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .user-card { background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; text-align: center; transition: all 0.3s; }
        .user-card.waiting { border-left: 5px solid #007bff; }
        .user-card.active { border-left: 5px solid #28a745; background-color: #e8f5e9; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .user-id { font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .user-rank { font-size: 1.2rem; font-weight: bold; color: #333; }
        .status-text { font-size: 0.7rem; margin-top: 5px; font-weight: bold; }

        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-stop { background: #dc3545; margin-left: 10px; }
        /* ì¶”ê°€ëœ ìŠ¤íƒ€ì¼: ì¢…ë£Œ ë²„íŠ¼ */
        .btn-close-each {
            margin-top: 8px;
            background: #f8f9fa;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            padding: 2px 5px;
        }
        .btn-close-each:hover { background: #e2e6ea; }
        .status-closed { color: #dc3545 !important; }
        input { padding: 8px; width: 80px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="control-panel">
    <h2>ğŸš€ WQM ë¶€í•˜ í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</h2>
    <label>í…ŒìŠ¤íŠ¸ ìœ ì € ìˆ˜ (1~500): </label>
    <input type="number" id="userCount" value="10" min="1" max="500">
    <button class="btn" onclick="startBulkTest()">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
    <button class="btn btn-stop" onclick="stopAllTests()">ëª¨ë‘ ì¤‘ì§€</button>
    <div id="summary" style="margin-top: 10px; font-size: 0.9rem; color: #555;">
        ëŒ€ê¸°: <span id="wait-count">0</span> | ì…ì¥ê°€ëŠ¥: <span id="active-count">0</span>
    </div>
</div>

<div id="test-grid" class="grid-container">
</div>

<script>
    // 1. ê´€ë¦¬ë¥¼ ìœ„í•´ ê°ì²´(Object) í˜•íƒœë¡œ ë³€ê²½
    let eventSources = {};

    async function startBulkTest() {
        const count = document.getElementById('userCount').value;
        const grid = document.getElementById('test-grid');
        stopAllTests();
        grid.innerHTML = '';

        for (let i = 1; i <= count; i++) {
            const userId = 'user' + i;
            createCard(userId);
            subscribe(userId);
            await new Promise(resolve => setTimeout(resolve, 50)); // ë¶€í•˜ ë¶„ì‚° ê°„ê²© ì¡°ì •
        }
    }

    function createCard(userId) {
        const grid = document.getElementById('test-grid');
        const card = document.createElement('div');
        card.id = 'card-' + userId;
        card.className = 'user-card waiting';
        card.innerHTML = `
            <div class="user-id">${userId}</div>
            <div id="rank-${userId}" class="user-rank">-</div>
            <div id="status-${userId}" class="status-text" style="color:#007bff;">ëŒ€ê¸°ì¤‘</div>
            <button class="btn-close-each" onclick="stopSingleTest('${userId}')">ì—°ê²° ì¢…ë£Œ</button>
        `;
        grid.appendChild(card);
    }

    function subscribe(userId) {
        const es = new EventSource(`/api/v1/queue/subscribe?userId=${userId}`);

        // 2. userIdë¥¼ í‚¤ë¡œ ì €ì¥
        eventSources[userId] = es;

        es.addEventListener('queue-status', function(event) {
            const rankDisplay = document.getElementById('rank-' + userId);
            const statusText = document.getElementById('status-' + userId);
            const card = document.getElementById('card-' + userId);

            if (!rankDisplay) return; // ì¹´ë“œê°€ ì´ë¯¸ ì‚­ì œëœ ê²½ìš° ë°©ì–´ ë¡œì§

            if (event.data.includes("ì…ì¥")) {
                rankDisplay.innerText = "PASS";
                statusText.innerText = "ì…ì¥ ê°€ëŠ¥";
                statusText.style.color = "#28a745";
                card.className = "user-card active";
            } else {
                const rank = event.data.replace(/[^0-9]/g, "");
                rankDisplay.innerText = rank;
                statusText.innerText = "ëŒ€ê¸° ìˆœë²ˆ";
            }
            updateSummary();
        });

        es.onerror = function() {
            console.error(userId + " ì—°ê²° ì˜¤ë¥˜ ë˜ëŠ” ì¢…ë£Œ");
            stopSingleTest(userId);
        };
    }

    // íŠ¹ì • ìœ ì €ë§Œ ì—°ê²°ì„ ì¢…ë£Œí•˜ê³  ì„œë²„ ëŒ€ê¸°ì—´ì—ì„œ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
    async function stopSingleTest(userId) {
        // 1. ì„œë²„ì— ëŒ€ê¸°ì—´ ì´íƒˆ(Out) ìš”ì²­ ë³´ë‚´ê¸°
        console.log("stopSingleTest: " + userId);
        try {
            const response = await fetch(`/api/v1/queue/out?userId=${userId}`, {
                method: 'POST'
            });

            if (response.ok) {
                console.log(`${userId} ì„œë²„ ëŒ€ê¸°ì—´ ì‚­ì œ ì™„ë£Œ`);
            } else {
                console.error(`${userId} ì„œë²„ ì‚­ì œ ì‹¤íŒ¨`);
            }
        } catch (error) {
            console.error(`${userId} í†µì‹  ì˜¤ë¥˜:`, error);
        }

        // 2. í´ë¼ì´ì–¸íŠ¸ SSE ì—°ê²° ì¢…ë£Œ
        if (eventSources[userId]) {
            eventSources[userId].close(); // SSE ì—°ê²° ì¢…ë£Œ
            delete eventSources[userId];   // ê°ì²´ì—ì„œ ì œê±°

            // UI ë³€ê²½
            const statusText = document.getElementById('status-' + userId);
            const rankDisplay = document.getElementById('rank-' + userId);
            const card = document.getElementById('card-' + userId);

            if (statusText) {
                statusText.innerText = "ì´íƒˆ(Out) ì™„ë£Œ";
                statusText.className = "status-text status-closed";
            }
            if (rankDisplay) {
                rankDisplay.innerText = "OUT";
                rankDisplay.style.color = "#666";
            }
            if (card) {
                card.style.opacity = "0.6"; // ë‚˜ê°„ ìœ ì €ëŠ” íë¦¬ê²Œ í‘œì‹œ
            }

            updateSummary();
        }
    }

    // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¤‘ì§€ ì‹œì—ë„ ê°ê° out ì²˜ë¦¬ë¥¼ í•˜ë ¤ë©´ ìˆ˜ì •
    async function stopAllTests() {
        const userIds = Object.keys(eventSources);
        for (const userId of userIds) {
            await stopSingleTest(userId); // ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ ìš”ì²­
        }
        document.getElementById('test-grid').innerHTML = '<p>ëª¨ë“  ìœ ì €ê°€ ëŒ€ê¸°ì—´ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
        updateSummary();
    }
    function updateSummary() {
        const total = Object.keys(eventSources).length;
        const active = document.querySelectorAll('.user-card.active').length;
        document.getElementById('wait-count').innerText = total - active;
        document.getElementById('active-count').innerText = active;
    }
</script>
</body>
</html>