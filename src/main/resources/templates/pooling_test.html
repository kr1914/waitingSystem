<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>접속 대기열</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f7f6; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        .rank { font-size: 3rem; font-weight: bold; color: #2c3e50; margin: 1rem 0; }
        .status { color: #7f8c8d; margin-bottom: 2rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>서비스 접속 대기 중</h2>
    <div id="wait-box">
        <div class="loader"></div>
        <p class="rank"><span id="rank-value">-</span>명</p>
        <p class="status">현재 대기 인원이 있습니다.<br>잠시만 기다려 주세요.</p>
    </div>

    <div id="complete-box" class="hidden">
        <h3 style="color: #27ae60;">입장 가능!</h3>
        <p>잠시 후 메인 페이지로 이동합니다.</p>
        <button onclick="location.reload()">다시 테스트</button>
    </div>
</div>
<script>
    const userId = "user_" + Math.floor(Math.random() * 10000);
    const rankElement = document.getElementById('rank-value');
    const waitBox = document.getElementById('wait-box');
    const completeBox = document.getElementById('complete-box');

    // 1초마다 실행될 함수
    async function checkQueueStatus() {
        try {
            const response = await fetch(`/api/v2/queue/poolingSessinon?userId=${userId}`, {
                method: 'POST'
            });

            if (!response.ok) throw new Error("서버 응답 오류");

            const data = await response.json(); // 스트림이 아니라 단일 JSON을 받음
            updateUI(data);

            // 상태가 완료가 아니면 1초 뒤에 다시 실행
            if (data.status !== "COMPLETED") {
                setTimeout(checkQueueStatus, 1000);
            }
        } catch (error) {
            console.error("Polling 중 오류 발생:", error);
            // 오류 발생 시 3초 뒤에 재시도
            setTimeout(checkQueueStatus, 3000);
        }
    }

    function updateUI(data) {
        rankElement.innerText = data.rank;
        if (data.status === "COMPLETED") {
            waitBox.classList.add('hidden');
            completeBox.classList.remove('hidden');
        }
    }

    // 처음 한 번 실행
    checkQueueStatus();
</script>
</body>
</html>